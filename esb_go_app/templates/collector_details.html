{{define "content"}}
<h1>{{T "Editing Collector"}}</h1>
<p>{{T "Here you can edit an existing data collector."}}</p>

{{if .ErrorMessage}}
<div class="status-message error">{{.ErrorMessage}}</div>
{{end}}

{{if .Collector}}
<form action="/admin/collectors/{{.Collector.ID}}/update" method="post" style="margin-bottom: 2em;">
    <div class="form-group">
        <label for="name">{{T "Name"}}</label>
        <input type="text" name="name" id="name" required value="{{.Collector.Name}}">
    </div>
    <div class="form-group">
        <label for="schedule">{{T "Schedule (Cron)"}}</label>
        <input type="text" name="schedule" id="schedule" required placeholder="*/5 * * * *" value="{{.Collector.Schedule}}">
    </div>
    <div class="form-group">
        <label for="integration_id">{{T "Integration (optional)"}}</label>
        <select name="integration_id" id="integration_id">
            <option value="">{{T "-- None --"}}</option>
            {{range .Integrations}}
            <option value="{{.ID}}" {{if eq .ID $.SelectedIntegrationID}}selected{{end}}>{{.Name}}</option>
            {{end}}
        </select>
    </div>
    <div class="form-group">
        <label for="engine">{{T "Engine"}}</label>
        <select name="engine" id="engine" required>
            <option value="javascript" {{if eq .Collector.Engine "javascript"}}selected{{end}}>JavaScript (Goja)</option>
            <option value="starlark" {{if eq .Collector.Engine "starlark"}}selected{{end}}>Starlark (Python-like)</option>
        </select>
    </div>
    <div class="form-group">
        <label for="script">{{T "Script"}}</label>
        <textarea name="script" id="script" rows="15" style="width: 100%; font-family: monospace;">{{.Collector.Script}}</textarea>
    </div>
    <button type="submit" class="btn">{{T "Save Changes"}}</button>
</form>

<details style="margin-top: 2em; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
    <summary style="font-weight: bold; cursor: pointer; padding-bottom: 5px;">{{T "Help with writing scripts for collectors"}}</summary>
    <p>{{T "Collector scripts are used to retrieve data from external sources and publish them to the ESB system. The script must return an array of JSON objects. Each object in the array will be published as a separate message."}}</p>

    <h4>{{T "Basic Principles:"}}</h4>
    <ul>
        <li><strong>{{T "Return Value:"}}</strong> {{T "The script MUST return a JSON-compatible array or a single JSON object. For example, `[{\"key\": \"value\"}, {\"another_key\": \"another_value\"}]` or `{\"another_key\": \"another_value\"}`. If the script returns `null` or nothing, no messages will be published."}}</li>
        <li><strong>{{T "Message Publication:"}}</strong> {{T "Your task is only to receive and structure the data. The collector itself handles the publication of messages to RabbitMQ."}}</li>
        <li><strong>{{T "Error Handling:"}}</strong> {{T "Any errors that occur during script execution will be logged in the ESB logs."}}</li>
        <li><strong>{{T "Available Global Objects:"}}</strong>
            <ul>
                <li><code>log</code>: {{T "`log`: An object for logging information to the ESB console (e.g., `log.info(\"My message\")`, `log.warn(\"Warning\")`, `log.error(\"Error\")`)."}}</li>
                <li><code>fetch</code>: {{T "`fetch` (JavaScript only): A function for making HTTP requests. Returns an object with `status` (number) and `json()` (function for parsing the response body) fields."}}</li>
                <li><code>http</code>: {{T "`http` (Starlark only): An object with methods `get(url)`, `post(url, body, headers)`, etc. Returns an object with `status_code` (number) and `json()` (function for parsing the response body) fields."}}</li>
            </ul>
        </li>
    </ul>

    <h4>{{T "Script Examples:"}}</h4>

    <h5>{{T "JavaScript (Goja)"}}</h5>
    <p>{{T "Example of getting data from an external API and returning a list of objects:"}}</p>
    <pre><code class="language-javascript">
        function execute() {
            // {{T "// Execute HTTP GET request"}}
            var response = fetch('https://api.exchangerate-api.com/v4/latest/USD');

            // {{T "// Check response status"}}
            if (response.status === 200) {
                var data = response.json(); // {{T "var data = response.json(); // Parse JSON response"}}
                log.info("{{T "log.info(\\\"Received data: \\\" + JSON.stringify(data));"}}");
                return data; // {{T "return data; // Return an array of objects"}}
            } else {
                log.error("{{T "log.error(\\\"Error receiving data: \\\" + response.status);"}}");
                return null; // {{T "return null; // Return null in case of an error, so as not to publish a message"}}
            }
        }

        // {{T "// The script must return an execute function or the result immediately"}}
        execute();
    </code></pre>

    <h5>{{T "Starlark (Python-like)"}}</h5>
    <p>{{T "Example of getting data from an external API and returning a list of objects:"}}</p>
    <pre><code class="language-python">
        def collect():
            # {{T "# Main script logic"}}
            response = http.get(url="https://api.exchangerate-api.com/v4/latest/USD")

            if response.status_code == 200:
                data = response.json()
                log.info("{{T "log.info(\\\"Received data: %s\\\" % data)"}}")
                data # {{T "data # Return data"}}
            else:
                log.error("{{T "log.error(\\\"Error receiving data: %s\\\" % response.status_code)"}}")
                None # {{T "None # Return None so as not to publish a message"}}
    </code></pre>

    <p><strong>{{T "Important:"}}</strong> {{T "For making HTTP requests in Starlark, the global object `http` is used. For JavaScript, the global function `fetch` is used."}}</p>
</details>

{{else}}
<p>{{T "Collector not found."}}</p>
{{end}}

{{end}}