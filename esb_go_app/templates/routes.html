{{define "content"}}
<h1>{{T "Route Management"}}</h1>
<p>{{T "Here you can link outbound channels of some applications to inbound channels of others."}}</p>

{{if .StatusMessage}}
<div class="status-message success">{{.StatusMessage}}</div>
{{end}}
{{if .ErrorMessage}}
<div class="status-message error">{{.ErrorMessage}}</div>
{{end}}

<h2>{{T "Create New Route"}}</h2>
<form action="/admin/routes/create" method="post" style="margin-bottom: 2em;">
    <div class="form-group">
        <label for="name">{{T "Route Name:"}}</label>
        <input type="text" name="name" id="name" required>
    </div>
    <div class="form-group">
        <label for="integration_id">{{T "Integration (optional)"}}</label>
        <select name="integration_id" id="integration_id">
            <option value="">{{T "-- None --"}}</option>
            {{range .Integrations}}
            <option value="{{.ID}}">{{.Name}}</option>
            {{end}}
        </select>
    </div>
    <div class="form-group">
        <label for="source_channel_id">{{T "From Channel (Source)"}}</label>
        <select name="source_channel_id" id="source_channel_id" required>
            <option value="">{{T "-- Select source --"}}</option>
            {{range .RouteSources}}
            <option value="{{.ID}}">{{.Name}}</option>
            {{end}}
        </select>
    </div>

    <div class="form-group">
        <label for="route_type">{{T "Route Type"}}</label>
        <select name="route_type" id="route_type" onchange="toggleRouteFields()">
            <option value="direct">{{T "Direct"}}</option>
            <option value="transform">{{T "With Transformation"}}</option>
        </select>
    </div>

    <div id="transform-route-fields" class="form-group" style="display: none;">
        <label for="transformation_id">{{T "Transformation"}}</label>
        <select name="transformation_id" id="transformation_id">
            <option value="">{{T "-- Select transformation --"}}</option>
            {{range .Transformations}}
            <option value="{{.ID}}">{{.Name}} ({{.Engine}})</option>
            {{end}}
        </select>
    </div>

    <div class="form-group">
        <label for="destination_channel_id">{{T "To Channel (Destination)"}}</label>
        <select name="destination_channel_id" id="destination_channel_id">
            <option value="">{{T "-- Select inbound channel --"}}</option>
            {{range .InboundChannels}}
            <option value="{{.ID}}">{{.ApplicationName}} -> {{.Name}} (Dest: {{.Destination}})</option>
            {{end}}
        </select>
    </div>

    <button type="submit" class="btn">{{T "Create Route"}}</button>
</form>

<h2>{{T "Existing Routes"}}</h2>
{{if .Routes}}
<table>
    <thead>
        <tr>
            <th>{{T "Name"}}</th>
            <th>{{T "Source"}}</th>
            <th>{{T "Destination / Transformation"}}</th>
            <th>{{T "Type"}}</th>
            <th>{{T "Integration"}}</th>
            <th>{{T "Created"}}</th>
            <th>{{T "Action"}}</th>
        </tr>
    </thead>
    <tbody>
        {{range .Routes}}
        <tr>
            <td><a href="/admin/routes/{{.ID}}">{{.Name}}</a></td>
            <td>
                <strong>{{.SourceAppName}}</strong><br>
                <small>{{.SourceChannelName}}</small>
            </td>
            <td>
                {{if .TransformationID}}
                    <strong>{{T "Transformation:"}}</strong> {{.TransformationName}}<br>
                    <hr style="margin: 5px 0; border-color: #eee;">
                {{end}}
                <strong>{{.DestinationAppName}}</strong><br>
                <small>{{.DestinationChannelName}}</small>
            </td>
            <td>{{.RouteType}}</td>
            <td>{{if .IntegrationName}}{{.IntegrationName}}{{else}}N/A{{end}}</td>
            <td>{{.CreatedAt.Format "2006-01-02 15:04:05"}}</td>
            <td>
                <form action="/admin/routes/{{.ID}}/delete" method="post" onsubmit="return confirm('{{T `Are you sure you want to delete this route?`}}');">
                    <button type="submit" class="btn btn-danger">{{T "Delete"}}</button>
                </form>
            </td>
        </tr>
        {{end}}
    </tbody>
</table>
{{else}}
<p>{{T "No routes created yet."}}</p>
{{end}}

<script>
    function toggleRouteFields() {
        const routeType = document.getElementById('route_type').value;
        const transformFields = document.getElementById('transform-route-fields');
        const destChannel = document.getElementById('destination_channel_id');
        const transform = document.getElementById('transformation_id');

        if (routeType === 'direct') {
            transformFields.style.display = 'none';
            transform.required = false;
            destChannel.required = true;
        } else {
            transformFields.style.display = 'block';
            transform.required = true;
            destChannel.required = true;
        }
    }

    toggleRouteFields();
</script>

{{end}}